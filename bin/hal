#!/usr/bin/env python3
"""
HAL - Multi-Agent Team Manager

A command-line interface for managing Claude Code agent teams.
"""

import os
import sys
import argparse
import subprocess
import json
from pathlib import Path
from typing import Optional, List

# Add lib directory to path
SCRIPT_DIR = Path(__file__).parent.parent
sys.path.insert(0, str(SCRIPT_DIR / 'lib'))

VERSION = "1.0.0"
SESSION_NAME = "agent-team"


class HAL:
    """Main HAL CLI manager."""

    def __init__(self):
        self.agent_team_dir = SCRIPT_DIR
        self.orchestrator_path = SCRIPT_DIR / 'orchestrator.py'
        self.workspaces_dir = SCRIPT_DIR / 'workspaces'

        # Ensure workspaces directory exists
        self.workspaces_dir.mkdir(exist_ok=True)

    def _get_workspace_name(self, project_dir: str) -> str:
        """Generate workspace name from project directory."""
        project_path = Path(project_dir).resolve()
        # Use the project directory name as workspace name
        return project_path.name

    def _get_workspace_dir(self, project_dir: str) -> Path:
        """Get workspace directory for a project."""
        workspace_name = self._get_workspace_name(project_dir)
        return self.workspaces_dir / workspace_name

    def start(self, project_dir: str, no_attach: bool = False) -> int:
        """Start agent team for a project."""
        project_path = Path(project_dir).resolve()

        if not project_path.exists():
            print(f"Error: Project directory not found: {project_dir}", file=sys.stderr)
            return 1

        # Check workspace exists
        workspace_dir = self._get_workspace_dir(project_dir)
        workplan_file = workspace_dir / 'WORKPLAN.md'

        if not workplan_file.exists():
            print(f"Error: No workspace found for project: {project_path.name}")
            print(f"       Expected: {workplan_file}")
            print(f"\nRun first: hal init {project_dir}")
            return 1

        # Check if session already running
        if self._is_session_running():
            print(f"Error: Agent team already running (session: {SESSION_NAME})")
            print("Use 'hal stop' to stop it first, or 'hal attach' to view it")
            return 1

        print(f"Starting agent team for: {project_path}")
        print(f"Workspace: {workspace_dir}")

        # Run orchestrator with workspace parameter
        cmd = [
            str(self.orchestrator_path),
            str(project_path),
            '--workspace', str(workspace_dir)
        ]
        if no_attach:
            cmd.append('--no-attach')

        try:
            result = subprocess.run(cmd, cwd=self.agent_team_dir)
            return result.returncode
        except KeyboardInterrupt:
            print("\nCanceled.")
            return 130
        except Exception as e:
            print(f"Error starting agent team: {e}", file=sys.stderr)
            return 1

    def stop(self) -> int:
        """Stop running agent team gracefully."""
        if not self._is_session_running():
            print("No agent team running")
            return 0

        print(f"Stopping agent team (session: {SESSION_NAME})...")

        try:
            subprocess.run(['tmux', 'kill-session', '-t', SESSION_NAME],
                         check=True, capture_output=True)
            print("Agent team stopped")
            return 0
        except subprocess.CalledProcessError:
            print("Error: Failed to stop agent team", file=sys.stderr)
            return 1

    def kill(self) -> int:
        """Force kill all agent team processes."""
        print("Force killing agent team...")

        # Kill tmux session
        subprocess.run(['tmux', 'kill-session', '-t', SESSION_NAME],
                      capture_output=True)

        # TODO: Kill any orphaned claude processes
        # For now, tmux kill should be sufficient

        print("Agent team killed")
        return 0

    def status(self) -> int:
        """Show status of running agents."""
        if not self._is_session_running():
            print("Status: No agent team running")
            return 0

        print(f"Status: Agent team running (session: {SESSION_NAME})")

        # Try to find workspace and display PROGRESS.md
        try:
            result = subprocess.run(
                ['tmux', 'display-message', '-p', '-t', SESSION_NAME, '#{pane_current_path}'],
                capture_output=True,
                text=True,
                check=True
            )
            project_dir = result.stdout.strip()
            project_name = Path(project_dir).name
            workspace_dir = self.workspaces_dir / project_name
            progress_file = workspace_dir / 'PROGRESS.md'

            print(f"\nProject: {project_dir}")
            print(f"Workspace: {workspace_dir}")

            if progress_file.exists():
                print(f"\nProgress:")
                print("-" * 60)
                with open(progress_file) as f:
                    print(f.read())
            else:
                print(f"\nNo PROGRESS.md found yet")
        except Exception as e:
            print(f"\nCould not read progress: {e}")

        # Show pane info
        print("\nPanes:")
        try:
            result = subprocess.run(
                ['tmux', 'list-panes', '-t', SESSION_NAME, '-F',
                 '#{pane_index}: #{pane_current_command} (#{pane_width}x#{pane_height})'],
                capture_output=True,
                text=True,
                check=True
            )
            print(result.stdout)
        except Exception:
            pass

        return 0

    def list_sessions(self) -> int:
        """List all tmux sessions."""
        try:
            result = subprocess.run(['tmux', 'list-sessions'],
                                  capture_output=True, text=True)
            if result.returncode == 0:
                print("Tmux sessions:")
                print(result.stdout)
            else:
                print("No tmux sessions running")
            return 0
        except FileNotFoundError:
            print("Error: tmux not found. Install tmux first.", file=sys.stderr)
            return 1

    def attach(self) -> int:
        """Attach to running agent team session."""
        if not self._is_session_running():
            print("No agent team running to attach to")
            return 1

        try:
            subprocess.run(['tmux', 'attach-session', '-t', SESSION_NAME])
            return 0
        except Exception as e:
            print(f"Error attaching to session: {e}", file=sys.stderr)
            return 1

    def logs(self, agent_name: Optional[str] = None) -> int:
        """Show logs for agent(s)."""
        # TODO: Implement log viewing
        # For now, just show where logs would be
        print("Log viewing not yet implemented")
        print("For now, attach to the tmux session with 'hal attach'")
        return 0

    def init(self, project_dir: str) -> int:
        """Initialize workspace for a project."""
        project_path = Path(project_dir).resolve()

        if not project_path.exists():
            print(f"Error: Project directory not found: {project_dir}", file=sys.stderr)
            return 1

        # Create workspace directory
        workspace_dir = self._get_workspace_dir(project_dir)
        workspace_dir.mkdir(parents=True, exist_ok=True)

        workplan_dest = workspace_dir / 'WORKPLAN.md'

        if workplan_dest.exists():
            print(f"Error: Workspace already exists for project: {project_path.name}")
            print(f"       Location: {workspace_dir}")
            response = input("Overwrite WORKPLAN.md? [y/N] ").strip().lower()
            if response != 'y':
                print("Canceled")
                return 1

        # Copy template
        template_src = SCRIPT_DIR / 'WORKPLAN.template.md'

        try:
            import shutil
            shutil.copy(template_src, workplan_dest)
            print(f"Created workspace for: {project_path.name}")
            print(f"Location: {workspace_dir}")
            print(f"Workplan: {workplan_dest}")
            print(f"\nYour project remains clean: {project_path}/")
            print(f"\nNext steps:")
            print(f"1. Edit the workplan:")
            print(f"   vim {workplan_dest}")
            print(f"2. Start agents:")
            print(f"   hal start {project_dir}")
            return 0
        except Exception as e:
            print(f"Error creating workspace: {e}", file=sys.stderr)
            return 1

    def validate(self, project_dir: Optional[str] = None) -> int:
        """Validate WORKPLAN.md in workspace."""
        if project_dir:
            project_path = Path(project_dir).resolve()
        else:
            project_path = Path.cwd()

        if not project_path.exists():
            print(f"Error: Project directory not found: {project_path}", file=sys.stderr)
            return 1

        workspace_dir = self._get_workspace_dir(str(project_path))
        workplan_file = workspace_dir / 'WORKPLAN.md'

        if not workplan_file.exists():
            print(f"Error: No workspace found for project: {project_path.name}", file=sys.stderr)
            print(f"       Expected: {workplan_file}")
            print(f"\nRun first: hal init {project_path}")
            return 1

        print(f"Validating workspace for: {project_path.name}")
        print(f"Workplan: {workplan_file}")

        # Basic validation
        errors = []
        warnings = []

        with open(workplan_file) as f:
            content = f.read()

        # Check for required sections
        if '# Phase 1:' not in content and '## Phase 1:' not in content:
            errors.append("Missing 'Phase 1' section")

        if '# Phase 2:' not in content and '## Phase 2:' not in content:
            warnings.append("Missing 'Phase 2' section (integration phase)")

        if '@delivery-lead' not in content:
            warnings.append("No @delivery-lead tasks defined (integration may not happen)")

        # Count agent sections
        agent_count = content.count('@')
        if agent_count == 0:
            errors.append("No agent task sections found (use @agent-name)")

        # Report
        if errors:
            print("\n❌ Errors:")
            for error in errors:
                print(f"  - {error}")

        if warnings:
            print("\n⚠️  Warnings:")
            for warning in warnings:
                print(f"  - {warning}")

        if not errors and not warnings:
            print("✅ WORKPLAN.md looks good!")
            print(f"   Found {agent_count} agent sections")

        return 1 if errors else 0

    def agents(self) -> int:
        """List available agents."""
        print("Available agents:\n")

        agent_dir = SCRIPT_DIR
        agent_files = sorted(agent_dir.glob('*-*.md'))

        if not agent_files:
            print("No agent specifications found")
            return 1

        for agent_file in agent_files:
            # Skip template
            if 'template' in agent_file.name.lower():
                continue

            agent_name = agent_file.stem

            # Try to read description from frontmatter
            try:
                with open(agent_file) as f:
                    content = f.read()
                    if 'description:' in content:
                        # Extract description
                        for line in content.split('\n'):
                            if line.startswith('description:'):
                                desc = line.split('description:')[1].strip()
                                print(f"  @{agent_name:<25} {desc}")
                                break
                    else:
                        print(f"  @{agent_name}")
            except Exception:
                print(f"  @{agent_name}")

        print(f"\nUse these in WORKPLAN.md as section headers (e.g., '## @backend-architect Tasks')")
        return 0

    def _is_session_running(self) -> bool:
        """Check if agent team session is running."""
        try:
            result = subprocess.run(
                ['tmux', 'has-session', '-t', SESSION_NAME],
                capture_output=True
            )
            return result.returncode == 0
        except FileNotFoundError:
            return False


def main():
    parser = argparse.ArgumentParser(
        prog='hal',
        description='HAL - Multi-Agent Team Manager',
        epilog='For more info: https://github.com/your-repo/agent-team'
    )

    parser.add_argument('-v', '--version', action='version',
                       version=f'HAL {VERSION}')

    subparsers = parser.add_subparsers(dest='command', help='Command to run')

    # start command
    start_parser = subparsers.add_parser('start',
                                        help='Start agent team for a project')
    start_parser.add_argument('project', help='Project directory path')
    start_parser.add_argument('--no-attach', action='store_true',
                            help="Don't auto-attach to tmux session")

    # stop command
    subparsers.add_parser('stop', help='Stop running agent team')

    # kill command
    subparsers.add_parser('kill', help='Force kill agent team')

    # status command
    subparsers.add_parser('status', help='Show status of running agents')

    # list command
    subparsers.add_parser('list', help='List all tmux sessions')

    # attach command
    subparsers.add_parser('attach', help='Attach to running team session')

    # logs command
    logs_parser = subparsers.add_parser('logs', help='Show agent logs')
    logs_parser.add_argument('agent', nargs='?', help='Agent name (optional)')

    # init command
    init_parser = subparsers.add_parser('init',
                                       help='Initialize project with WORKPLAN template')
    init_parser.add_argument('project', help='Project directory path')

    # validate command
    validate_parser = subparsers.add_parser('validate',
                                           help='Validate WORKPLAN.md')
    validate_parser.add_argument('project', nargs='?',
                                help='Project directory (default: current dir)')

    # agents command
    subparsers.add_parser('agents', help='List available agents')

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return 0

    hal = HAL()

    # Dispatch to command
    if args.command == 'start':
        return hal.start(args.project, args.no_attach)
    elif args.command == 'stop':
        return hal.stop()
    elif args.command == 'kill':
        return hal.kill()
    elif args.command == 'status':
        return hal.status()
    elif args.command == 'list':
        return hal.list_sessions()
    elif args.command == 'attach':
        return hal.attach()
    elif args.command == 'logs':
        return hal.logs(args.agent)
    elif args.command == 'init':
        return hal.init(args.project)
    elif args.command == 'validate':
        return hal.validate(args.project)
    elif args.command == 'agents':
        return hal.agents()
    else:
        parser.print_help()
        return 1


if __name__ == '__main__':
    sys.exit(main())
